###
###
###
@content[][]

^switch[$uri:path_first]{
	^case[redirect]{
		^if(def $form:to){
			$response:location[^untaint{$form:to}]
		}{ ^404[] }
	}
	^case[auth]{^login[]}
	^case[ajax]{^use[ajax.p]^ajax:main[]}
	^case[admin]{^use[admin.p]^admin:main[]}
	^case[DEFAULT]{
		$MAIN:menu_id(^uri:inspect_uri[])
		^if($MAIN:menu_id > 0){
			^get_content_by_menu_id[$MAIN:menu_id]
		}{
			$page_correct(0)

			^if(^uri:path.count[] > 1){
				$MAIN:menu[^table::sql{select id, menu_id, menu_title, menu_uri, menu_parent_id, visible, module from ${MAIN:sql_config.table_prefix}menu where menu_uri = '$uri:path.piece' and menu_parent_id = '0'}[$.limit(1) $.offset(0)]]
				^if($MAIN:menu){
					^if(def $MAIN:menu.module){
						$page_correct(1)
						^get_content_by_menu_id[$MAIN:menu.id]
					}
				}
			}

			^if($page_correct eq "0"){ ^404[] }
		}
	}
}

###
###
###
@get_content_by_menu_id[menu_id][]
^if(def $menu_id){
	$MAIN:menu_id[$menu_id]
	$MAIN:current_section[^table::sql{select id, menu_id, menu_title, menu_uri, menu_parent_id, visible, module from ${MAIN:sql_config.table_prefix}menu where id = '$MAIN:menu_id'}]
	$MAIN:current_document[^table::sql{select id, menu_id, title, keywords, description, h1, body, published, updated from ${MAIN:sql_config.table_prefix}content where menu_id = '$MAIN:menu_id'}]

	^if(-f "/cms/classes/modules/$MAIN:current_section.module"){
	$module_[
		$module_name[$MAIN:current_section.module]
		^use[$module_name]

		^process{^^^module_name.left(^module_name.pos[.]):index[]}

		^if($MAIN:user_status eq "99"){
			<div class="admin_link"><input type="button" value="Управление модулем" onClick="show_modal('${MAIN:language_prefix}/admin/module/?id=$module_name&menu_id=$MAIN:menu_id')" /></div>
			<br /><br /><br />
		}
	]
	}

	^if($MAIN:hide_index_text ne "1"){
		^if($MAIN:current_document){
			<h1>$MAIN:current_document.h1</h1>
			$MAIN:meta_title[^if(def $MAIN:current_document.title){$MAIN:current_document.title}{$MAIN:current_document.h1}]
			^untaint{$MAIN:current_document.body}
		}{
			<h1>$MAIN:current_section.menu_title</h1>
			$MAIN:meta_title[$MAIN:current_section.menu_title]
		}
		^if($MAIN:user_status eq "99"){
			<div class="admin_link"><input type="button" value="Изменить текст" onClick="show_modal('${MAIN:language_prefix}/admin/edit_content/?id=^MAIN:menu_id.int(0)')" /></div>
			<br /><br /><br />
		}
	}
	$module_

}


###
###
###
@404[][]
^if($request:uri ne "/"){$response:status(404)}
<h1>Страница не найдена</h1>
<p />Документ <a href="${request:uri}">http://${env:HTTP_HOST}${request:uri}</a> не найден.
<p />Причины, которые могли привести к ошибке:
<ul>
<li /><b>Неправильно набран адрес</b><br />проверьте правильность адреса документа
<li /><b>Такой страницы никогда не было на этом сайте</b><br />зайдите на главную страницу или воспользуйтесь поиском
<li /><b>Такая страница была, но по этому адресу ее больше нет</b><br />пожалуйста, сообщите об этом <a href="mailto:info@millmark.ru">администратору</a>
</ul>

###
###
###
@login[][]
^if(def $form:password){
	^if($form:password eq "rusconkutir"){
		$cookie:ruscon_is_admin[
			$.value[1]
			$.expires[session]
		]
		$response:location[http://${env:HTTP_HOST}/]
	}
}

<form action="$request:uri" method="post">
<input type="password" name="password" value="" />
<input type="submit" value="Авторизация" />
</form>
